# Node-RED Integration Guide

This guide explains how Node-RED is integrated into the FusionForecast Docker environment, how to manage credentials securely, and how to handle version control.

## 1. Docker Setup

Node-RED runs as a service named `nodered` within the `docker-compose.yml`.

*   **Image:** `nodered/node-red:latest` (Official Image)
*   **Port:** `1880` (Mapped to host)
*   **URL:** [http://localhost:1880](http://localhost:1880)

### Volume Mapping
To ensure persistence and easy development, we mount the entire `node_red/` directory from the host to the container:

```yaml
volumes:
  - nodered-data:/data              # Persistent storage (installed nodes, settings)
  - ../node_red:/data               # Mounts local files (flows.json, flows_cred.json)
```

**Note:** We changed the mount strategy to mount the **directory** instead of individual files. This prevents `EBUSY` errors on Windows when Node-RED tries to save changes.

## 2. Credential Management

Node-RED encrypts credentials (like tokens and passwords) and stores them in a separate file. To allow sharing the project without leaking secrets, we use a specific workflow.

### The Files
*   **`flows.json`**: Contains the logic (nodes and wires). **Commit this to Git.**
*   **`flows_cred.json`**: Contains the **encrypted** secrets. **DO NOT commit this.**
*   **`flows_cred.json.example`**: A template file with placeholders. **Commit this.**

### Configuration
We use **Environment Variables** in the credentials file to avoid hardcoding secrets.

1.  **flows_cred.json** (Runtime file, ignored by Git):
    ```json
    {
        "$": "efd90bbafdaf8d704039e13a3ddc91bb..." // Encrypted content generated by Node-RED
    }
    ```
    *When you first start, you might need to manually set the credentials in the Node-RED UI.*

2.  **Environment Variables**:
    The InfluxDB node in the Docker container is configured to use the following variables from your `.env` file:
    *   `INFLUXDB_URL` -> `http://influxdb:8086`
    *   `INFLUXDB_TOKEN`
    *   `INFLUXDB_ORG`

    In the Node-RED flow (if you inspect the raw file), you might see references like `$(INFLUXDB_TOKEN)`. This tells Node-RED to substitute the value from the environment.

## 3. Git Workflow

When working with Node-RED, many files are generated automatically. We have configured `.gitignore` to keep the repository clean.

### What to Commit ✅
*   `node_red/flows.json` (The logic)
*   `node_red/README.md` (Documentation)
*   `node_red/flows_cred.json.example` (Template)

### What is Ignored ❌
*   `node_red/node_modules/` (Installed libraries)
*   `node_red/package-lock.json`
*   `node_red/settings.js` (Runtime settings)
*   `node_red/flows_cred.json` (Your local secrets)
*   `node_red/.*.backup` (Backup files)

## 4. Troubleshooting

**"Unauthorized Access" Error:**
If you see this error in the debug log, it usually means the InfluxDB node is missing the credentials.
1.  Open Node-RED at `http://localhost:1880`.
2.  Double-click the InfluxDB node.
3.  Click the pencil icon next to the Server configuration.
4.  Re-enter your `Token` and `Organization`.
5.  Click Update -> Done -> **Deploy**.

**"EBUSY: resource busy or locked":**
This happens on Windows if individual files are mounted. Ensure your `docker-compose.yml` mounts the directory: `- ../node_red:/data`.
