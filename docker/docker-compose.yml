version: '3.8'

services:
  influxdb:
    image: influxdb:2.7
    container_name: fusionforecast-influxdb
    restart: unless-stopped
    ports:
      - "8086:8086"
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2
      - influx-shared:/shared
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_USERNAME:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD:-changeme123}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG:-fusionforecast}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_INIT_BUCKET:-default}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_TOKEN}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8086/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - fusionforecast-network

  fusionforecast:
    build:
      context: ..
      dockerfile: docker/Dockerfile.fusionforecast
    container_name: fusionforecast-app
    restart: unless-stopped
    depends_on:
      influxdb:
        condition: service_healthy
    volumes:
      - ../settings.example.toml:/app/settings.toml.template:ro
      - ../logs:/app/logs
      - ../models:/app/models
      - ../measurements.csv:/app/measurements.csv # Uncomment to auto-import history
      - influx-shared:/shared:ro
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-fusionforecast}
      - INFLUXDB_USERNAME=${INFLUXDB_USERNAME:-admin}
      - INFLUXDB_PASSWORD=${INFLUXDB_PASSWORD:-changeme123}
      - STATION_LATITUDE=${STATION_LATITUDE}
      - STATION_LONGITUDE=${STATION_LONGITUDE}
      - STATION_TILT=${STATION_TILT:-30}
      - STATION_AZIMUTH=${STATION_AZIMUTH:-0}
      - MODEL_TRAINING_DAYS=${MODEL_TRAINING_DAYS:-30}
      - MAX_POWER_CLIP=${MAX_POWER_CLIP:-6000}

    networks:
      - fusionforecast-network

  nodered:
    build:
      context: ..
      dockerfile: docker/Dockerfile.nodered
    container_name: fusionforecast-nodered
    restart: unless-stopped
    ports:
      - "1880:1880"
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-fusionforecast}
      - CREDENTIAL_SECRET=${NODERED_CREDENTIAL_SECRET:-fusionForecastSecret}

    volumes:
      - ../node_red:/data
    depends_on:
      - influxdb
      - fusionforecast
    networks:
      - fusionforecast-network

volumes:
  influxdb-data:
    driver: local
  influxdb-config:
    driver: local
  influx-shared:
    driver: local
  nodered-data:
    driver: local

networks:
  fusionforecast-network:
    driver: bridge
